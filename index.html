<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
  <meta name="theme-color" content="#14100d" />
  <meta name="description" content="D&D Companion App">
  <title>–ó–∞–ø–∏—Å–∫–∏ —Å—É–º–∞—Å—à–µ–¥—à–µ–≥–æ</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* ===== CSS STYLES ===== */
    :root {
      --bg-dark: #14100d;
      --bg-panel: #1e1915;
      --bg-card: #26201b;
      --accent: #c2a86f;        /* –ó–æ–ª–æ—Ç–æ */
      --accent-dim: #8a7545;    /* –ë—Ä–æ–Ω–∑–∞ */
      --danger: #d32f2f;
      --text-main: #e8e0d5;
      --text-muted: #9c9085;
      --border: rgba(194, 168, 111, 0.2);
      --glass: rgba(30, 25, 21, 0.9);
      --radius: 12px;
      --safe-area-bottom: env(safe-area-inset-bottom, 20px);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: 'Lato', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* –§–æ–Ω–æ–≤—ã–π —à—É–º */
    .bg-noise {
      position: fixed; inset: 0; pointer-events: none; z-index: -1; opacity: 0.04;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }

    h1, h2, h3 { font-family: 'Cinzel', serif; margin: 0; font-weight: 700; color: var(--accent); }
    p { margin: 0 0 1rem 0; line-height: 1.5; color: var(--text-muted); }

    /* --- HEADER --- */
    .app-header {
      height: 60px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 1rem;
      background: var(--glass);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      z-index: 10;
      flex-shrink: 0;
    }
    .app-title { font-family: 'Cinzel', serif; font-weight: 700; text-transform: uppercase; color: var(--accent); }
    .header-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0.5rem; }

    /* --- MAIN CONTENT --- */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      padding-bottom: calc(80px + var(--safe-area-bottom));
      scroll-behavior: smooth;
    }
    .container { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 1.5rem; }

    /* --- IMAGES (FIXED) --- */
    .image-frame {
      background: #000;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      max-height: 60vh;
      width: 100%;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
    }
    .image-frame img {
      width: 100%;
      height: auto;
      max-height: 60vh;
      object-fit: contain;
      display: block;
      opacity: 0; transition: opacity 0.4s ease;
    }
    .image-frame img.loaded { opacity: 1; }

    /* --- CARDS --- */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    /* --- STATS SCROLLER --- */
    .stats-scroller {
      display: flex; gap: 0.8rem; overflow-x: auto;
      padding-bottom: 0.5rem; scroll-snap-type: x mandatory;
    }
    .stat-card {
      flex: 0 0 110px;
      scroll-snap-align: start;
      background: var(--bg-panel);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 0.8rem;
      display: flex; flex-direction: column; align-items: center; gap: 0.5rem;
    }
    .stat-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); }

    .stepper { display: flex; align-items: center; background: #111; border-radius: 8px; }
    .stepper button {
      width: 30px; height: 30px; border: none; background: transparent; color: var(--accent);
      font-size: 1.2rem; cursor: pointer;
    }
    .stepper span { width: 30px; text-align: center; color: #fff; font-weight: bold; }

    /* --- BUTTONS --- */
    .btn {
      width: 100%; padding: 0.9rem; border: none; border-radius: 10px;
      font-family: 'Cinzel', serif; font-weight: 700; font-size: 1rem;
      background: linear-gradient(135deg, var(--accent), var(--accent-dim));
      color: #1a1614; cursor: pointer; margin-bottom: 0.5rem;
    }
    .btn:active { transform: scale(0.98); }
    .btn.ghost { background: transparent; border: 1px solid var(--border); color: var(--accent); }
    .btn.danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); width: auto; padding: 0.3rem 0.6rem; font-family: sans-serif; }

    .btn-group { display: flex; gap: 1rem; margin-top: 1rem; }

    /* --- LISTS (Inventory/Notes) --- */
    .list-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.8rem; border-bottom: 1px solid #333;
      background: rgba(0,0,0,0.2); margin-bottom: 4px; border-radius: 6px;
    }
    .list-item:last-child { border-bottom: none; }
    .list-text { flex: 1; margin-right: 1rem; word-break: break-word; }

    /* --- INPUTS --- */
    .input-field {
      width: 100%; padding: 0.8rem; border-radius: 8px;
      border: 1px solid var(--border); background: #111; color: #fff;
      font-family: 'Lato', sans-serif; font-size: 1rem;
    }
    textarea.input-field { resize: vertical; min-height: 80px; }

    /* --- BOTTOM NAV --- */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: calc(65px + var(--safe-area-bottom));
      padding-bottom: var(--safe-area-bottom);
      background: var(--glass);
      backdrop-filter: blur(12px);
      border-top: 1px solid var(--border);
      display: flex; justify-content: space-around; align-items: center;
      z-index: 100;
    }
    .nav-item {
      background: none; border: none; color: var(--text-muted);
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      font-size: 0.7rem; width: 25%; cursor: pointer;
    }
    .nav-icon { font-size: 1.4rem; filter: grayscale(1); transition: 0.2s; }
    .nav-item.active { color: var(--accent); }
    .nav-item.active .nav-icon { filter: grayscale(0); }

    /* --- MODAL --- */
    .modal {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .modal.open { opacity: 1; pointer-events: auto; }
    .modal-content {
      background: var(--bg-card); width: 90%; max-width: 500px; max-height: 85vh;
      border-radius: 16px; border: 1px solid var(--border); padding: 1.5rem;
      overflow-y: auto; transform: translateY(20px); transition: transform 0.2s;
    }
    .modal.open .modal-content { transform: translateY(0); }

    /* --- GRID CARDS --- */
    .grid-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    .char-card img { width: 100%; border-radius: 8px; aspect-ratio: 1; object-fit: cover; }

    /* --- TOAST --- */
    .toast {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
      background: #eee; color: #111; padding: 10px 20px; border-radius: 20px;
      font-weight: bold; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 300;
    }
    .toast.show { opacity: 1; }

    [hidden] { display: none !important; }
  </style>
</head>
<body>
  <div class="bg-noise"></div>

  <header class="app-header">
    <button id="btn-home" class="header-btn" title="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">üè∞</button>
    <div class="app-title">–ó–∞–ø–∏—Å–∫–∏</div>
    <div id="char-indicator" style="width:32px; height:32px; border-radius:50%; background:#333; background-size:cover; border:1px solid var(--accent)" hidden></div>
  </header>

  <main id="app" class="main-content"></main>

  <div id="toast" class="toast">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>

  <nav id="bottom-nav" class="bottom-nav" hidden>
    <button data-nav="dice" class="nav-item">
      <span class="nav-icon">üé≤</span>
      <span>–ö–æ—Å—Ç–∏</span>
    </button>
    <button data-nav="inv" class="nav-item">
      <span class="nav-icon">üéí</span>
      <span>–í–µ—â–∏</span>
    </button>
    <button data-nav="notes" class="nav-item">
      <span class="nav-icon">üìú</span>
      <span>–ó–∞–º–µ—Ç–∫–∏</span>
    </button>
    <button data-nav="map" class="nav-item active">
      <span class="nav-icon">üìç</span>
      <span>–ö–∞—Ä—Ç–∞</span>
    </button>
  </nav>

  <script>
    /* ===== JAVASCRIPT LOGIC ===== */
    const APP = (() => {
      // –ö—ç—à–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM
      const els = {
        app: document.getElementById('app'),
        toast: document.getElementById('toast'),
        btnHome: document.getElementById('btn-home'),
        bottomNav: document.getElementById('bottom-nav'),
        charIndicator: document.getElementById('char-indicator'),
        navItems: document.querySelectorAll('.nav-item')
      };

      const STORAGE_KEY = 'dnd_companion_v3';

      // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      let state = {
        data: { characters: [], locations: [] },
        user: {
          selectedCharId: null,
          charData: null, // –ó–¥–µ—Å—å —Ö—Ä–∞–Ω–∏–º —Å—Ç–∞—Ç—ã, –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏ –∑–∞–º–µ—Ç–∫–∏
          locationIndex: 0
        }
      };

      // --- –£—Ç–∏–ª–∏—Ç—ã ---
      const showToast = (msg) => {
        els.toast.textContent = msg;
        els.toast.classList.add('show');
        setTimeout(() => els.toast.classList.remove('show'), 2000);
      };

      const saveState = () => {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state.user));
        } catch(e) { console.error('Save failed', e); }
      };

      const loadState = () => {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          try {
            const parsed = JSON.parse(raw);
            if (parsed.charData) state.user = parsed;
          } catch(e) {}
        }
      };

      // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
      async function init() {
        try {
          // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
          const [charsRes, locsRes] = await Promise.all([
            fetch('./characters.json'),
            fetch('./locations.json')
          ]);

          if (!charsRes.ok || !locsRes.ok) throw new Error("JSON files not found");

          const charsData = await charsRes.json();
          const locsData = await locsRes.json();

          state.data.characters = charsData.characters || [];
          state.data.locations = locsData.locations || [];

          loadState();

          // –†–æ—É—Ç–∏–Ω–≥
          if (state.user.selectedCharId && state.user.charData) {
            renderLocationScreen();
          } else {
            renderMainMenu();
          }
        } catch (e) {
          els.app.innerHTML = `
            <div class="container" style="text-align:center">
              <div class="card">
                <h3>–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞</h3>
                <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (characters.json / locations.json).</p>
                <p style="font-size:0.8rem; color:red">${e.message}</p>
                <button class="btn" onclick="location.reload()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
              </div>
            </div>`;
        }
      }

      // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥: –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ---
      function renderMainMenu() {
        els.bottomNav.hidden = true;
        els.charIndicator.hidden = true;

        els.app.innerHTML = `
          <div class="container" style="text-align:center; padding-top:3rem;">
            <h1 style="font-size:2.5rem; margin-bottom:1rem">–ó–∞–ø–∏—Å–∫–∏<br>–°—É–º–∞—Å—à–µ–¥—à–µ–≥–æ</h1>
            <p>–í–∞—à —Å–ø—É—Ç–Ω–∏–∫ –≤ –º–∏—Ä–µ D&D</p>
            <div style="margin-top:2rem;">
              <button class="btn" id="btn-new-game">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
              ${state.user.charData ? `<button class="btn ghost" id="btn-continue">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>` : ''}
            </div>
          </div>
        `;

        document.getElementById('btn-new-game').onclick = renderCharSelect;
        const btnCont = document.getElementById('btn-continue');
        if (btnCont) btnCont.onclick = renderLocationScreen;
      }

      // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥: –í—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ---
      function renderCharSelect() {
        els.app.innerHTML = `
          <div class="container">
            <h2 style="text-align:center">–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è</h2>
            <div class="grid-cards" id="char-grid"></div>
            <button class="btn ghost" id="back-to-menu">–ù–∞–∑–∞–¥</button>
          </div>
        `;

        const grid = document.getElementById('char-grid');
        const hiddenIds = ['korgreyv', 'porje', 'andrey'];

        state.data.characters.forEach(char => {
          if (hiddenIds.includes(String(char.id))) return;

          const card = document.createElement('div');
          card.className = 'card char-card';
          card.style.cursor = 'pointer';
          card.innerHTML = `
            <img src="images/${char.image}" alt="${char.name}">
            <h3 style="margin-top:0.5rem; font-size:1rem">${char.name}</h3>
            <p style="font-size:0.8rem; margin:0">${char.class}</p>
          `;
          card.onclick = () => startGame(char);
          grid.appendChild(card);
        });

        document.getElementById('back-to-menu').onclick = renderMainMenu;
      }

      function startGame(char) {
        // –°–æ–∑–¥–∞–µ–º –≥–ª—É–±–æ–∫—É—é –∫–æ–ø–∏—é, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Ç—Ä–æ–≥–∞–ª–∏ –∏—Å—Ö–æ–¥–Ω—ã–π JSON
        state.user.charData = JSON.parse(JSON.stringify(char));
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        if (!state.user.charData.inventory) state.user.charData.inventory = [];
        if (!state.user.charData.notes) state.user.charData.notes = [];

        state.user.selectedCharId = char.id;
        state.user.locationIndex = 0;

        saveState();
        renderLocationScreen();
      }

      // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥: –õ–æ–∫–∞—Ü–∏—è (–û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω) ---
      function renderLocationScreen() {
        const loc = state.data.locations[state.user.locationIndex];
        if (!loc) return;

        // UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        els.bottomNav.hidden = false;
        setActiveNav('map');

        if (state.user.charData?.image) {
          els.charIndicator.hidden = false;
          els.charIndicator.style.backgroundImage = `url('images/${state.user.charData.image}')`;
        }

        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞
        if (state.user.locationIndex + 1 < state.data.locations.length) {
          new Image().src = `images/${state.data.locations[state.user.locationIndex + 1].image}`;
        }

        els.app.innerHTML = '';
        const container = document.createElement('div');
        container.className = 'container';

        // 1. –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const imgFrame = document.createElement('div');
        imgFrame.className = 'image-frame';
        const img = new Image();
        img.src = `images/${loc.image}`;
        img.onload = () => img.classList.add('loaded');
        img.onerror = () => { img.classList.add('loaded'); }; // –ó–∞–≥–ª—É—à–∫—É —É–±—Ä–∞–ª –¥–ª—è —ç—Å—Ç–µ—Ç–∏–∫–∏
        imgFrame.appendChild(img);
        container.appendChild(imgFrame);

        // --- –õ–û–ì–ò–ö–ê –ü–û–Ø–í–õ–ï–ù–ò–Ø –ù–û–í–´–• –ü–ï–†–°–û–ù–ê–ñ–ï–ô ---
        const showUnlockBtn = String(loc.title || '').toLowerCase().includes('–∫–æ–ª–ª–µ–≥–∏—è –º–∞–≥–æ–≤');

        // 2. –¢–µ–∫—Å—Ç –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h2>${loc.title}</h2>
          <p>${loc.description}</p>

          ${showUnlockBtn ? `<button class="btn ghost" id="btn-unlock" style="border-color:var(--accent); margin-top:1rem">üë• –í—Å—Ç—Ä–µ—Ç–∏—Ç—å –Ω–æ–≤—ã—Ö —Å–ø—É—Ç–Ω–∏–∫–æ–≤</button>` : ''}

          <div class="btn-group">
            ${state.user.locationIndex > 0 ? `<button class="btn ghost" id="prev-loc">‚Üê –ù–∞–∑–∞–¥</button>` : '<div></div>'}
            ${state.user.locationIndex < state.data.locations.length - 1 ? `<button class="btn" id="next-loc">–í–ø–µ—Ä—ë–¥ ‚Üí</button>` : ''}
          </div>
        `;
        container.appendChild(card);

        // 3. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–°–∫—Ä–æ–ª–ª)
        const statsWrap = document.createElement('div');
        statsWrap.innerHTML = `<h3>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>`;
        const scroller = document.createElement('div');
        scroller.className = 'stats-scroller';

        Object.entries(state.user.charData.stats || {}).forEach(([key, val]) => {
          const statItem = document.createElement('div');
          statItem.className = 'stat-card';
          statItem.innerHTML = `
            <span class="stat-label">${key}</span>
            <div class="stepper">
              <button data-action="dec" data-key="${key}">‚àí</button>
              <span>${val}</span>
              <button data-action="inc" data-key="${key}">+</button>
            </div>
          `;
          scroller.appendChild(statItem);
        });

        // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –ø–æ —Å—Ç–∞—Ç–∞–º
        scroller.onclick = (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const key = btn.dataset.key;
          const span = btn.parentElement.querySelector('span');
          let currentVal = parseInt(span.textContent);

          if (btn.dataset.action === 'inc') currentVal++;
          else currentVal--;

          span.textContent = currentVal;
          state.user.charData.stats[key] = currentVal;
          saveState();
        };

        statsWrap.appendChild(scroller);
        container.appendChild(statsWrap);
        els.app.appendChild(container);

        // –õ–∏—Å—Ç–µ–Ω–µ—Ä—ã –∫–Ω–æ–ø–æ–∫
        document.getElementById('prev-loc')?.addEventListener('click', () => {
          state.user.locationIndex--;
          saveState();
          els.app.scrollTo(0, 0);
          renderLocationScreen();
        });
        document.getElementById('next-loc')?.addEventListener('click', () => {
          state.user.locationIndex++;
          saveState();
          els.app.scrollTo(0, 0);
          renderLocationScreen();
        });

        // –õ–∏—Å—Ç–µ–Ω–µ—Ä –¥–ª—è —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        if (showUnlockBtn) {
          document.getElementById('btn-unlock')?.addEventListener('click', openUnlockModal);
        }
      }

      // --- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏ –ª–æ–≥–∏–∫–∞ ---
      function openModal(type) {
        const modal = document.createElement('div');
        modal.className = 'modal';

        let content = '';

        // --- –ö–û–°–¢–ò ---
        if (type === 'dice') {
          content = `
            <h3>–ë—Ä–æ—Å–æ–∫ –∫–æ—Å—Ç–µ–π</h3>
            <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:1rem 0">
              ${['D4','D6','D8','D10','D12','D20'].map(d => `<button class="btn ghost dice-btn" data-d="${d}">${d}</button>`).join('')}
            </div>
            <div id="dice-log" class="card" style="height:150px; overflow-y:auto; font-family:monospace; font-size:0.9rem; background:#111"></div>
            <button class="btn" id="close-modal" style="margin-top:1rem">–ó–∞–∫—Ä—ã—Ç—å</button>
          `;
        }

        // --- –ò–ù–í–ï–ù–¢–ê–†–¨ ---
        else if (type === 'inv') {
          content = `
            <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
            <div style="display:flex; gap:0.5rem; margin-bottom:1rem">
              <input id="new-item-input" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞...">
              <button id="add-item-btn" class="btn" style="width:auto; margin:0">+</button>
            </div>
            <div id="list-container" style="max-height:50vh; overflow-y:auto"></div>
            <button class="btn ghost" id="close-modal" style="margin-top:1rem">–ó–∞–∫—Ä—ã—Ç—å</button>
          `;
        }

        // --- –ó–ê–ú–ï–¢–ö–ò ---
        else if (type === 'notes') {
          content = `
            <h3>–ó–∞–º–µ—Ç–∫–∏</h3>
            <div style="display:flex; flex-direction:column; gap:0.5rem; margin-bottom:1rem">
              <textarea id="new-note-input" class="input-field" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏..."></textarea>
              <button id="add-note-btn" class="btn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
            </div>
            <div id="list-container" style="max-height:40vh; overflow-y:auto"></div>
            <button class="btn ghost" id="close-modal" style="margin-top:1rem">–ó–∞–∫—Ä—ã—Ç—å</button>
          `;
        }

        modal.innerHTML = `<div class="modal-content">${content}</div>`;
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('open'), 10);

        // --- –õ–æ–≥–∏–∫–∞ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ ---
        const closeModal = () => {
          modal.classList.remove('open');
          setTimeout(() => modal.remove(), 250);
        };

        modal.addEventListener('click', (e) => {
          if (e.target === modal || e.target.id === 'close-modal') closeModal();

          // –õ–æ–≥–∏–∫–∞ –∫–æ—Å—Ç–µ–π
          if (e.target.classList.contains('dice-btn')) {
            const die = e.target.dataset.d;
            const max = parseInt(die.substring(1));
            const res = Math.floor(Math.random() * max) + 1;
            const log = modal.querySelector('#dice-log');
            log.innerHTML = `<div style="padding:5px; border-bottom:1px solid #333">üé≤ <strong>${die}</strong>: <span style="color:var(--accent); font-weight:bold">${res}</span></div>` + log.innerHTML;
          }
        });

        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ —Å–ø–∏—Å–∫–æ–≤ (–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å / –ó–∞–º–µ—Ç–∫–∏)
        const renderList = (arrayName, containerId) => {
          const container = modal.querySelector(containerId);
          if (!container) return;

          const list = state.user.charData[arrayName] || [];
          container.innerHTML = '';

          if (list.length === 0) {
            container.innerHTML = '<p style="text-align:center; opacity:0.5">–ü—É—Å—Ç–æ</p>';
            return;
          }

          list.forEach((item, index) => {
            const row = document.createElement('div');
            row.className = 'list-item';
            row.innerHTML = `
              <div class="list-text">${item}</div>
              <button class="btn danger" data-del="${index}">‚úñ</button>
            `;
            container.appendChild(row);
          });

          // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
          container.querySelectorAll('button[data-del]').forEach(btn => {
            btn.onclick = () => {
              const idx = parseInt(btn.dataset.del);
              state.user.charData[arrayName].splice(idx, 1);
              saveState();
              renderList(arrayName, containerId); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
            };
          });
        };

        // –õ–æ–≥–∏–∫–∞ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—è
        if (type === 'inv') {
          renderList('inventory', '#list-container');
          const addBtn = modal.querySelector('#add-item-btn');
          const input = modal.querySelector('#new-item-input');

          addBtn.onclick = () => {
            const val = input.value.trim();
            if (val) {
              if(!state.user.charData.inventory) state.user.charData.inventory = [];
              state.user.charData.inventory.push(val);
              saveState();
              input.value = '';
              renderList('inventory', '#list-container');
              showToast('–ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
            }
          };
        }

        // –õ–æ–≥–∏–∫–∞ –ó–∞–º–µ—Ç–æ–∫
        if (type === 'notes') {
          renderList('notes', '#list-container');
          const addBtn = modal.querySelector('#add-note-btn');
          const input = modal.querySelector('#new-note-input');

          addBtn.onclick = () => {
            const val = input.value.trim();
            if (val) {
              if(!state.user.charData.notes) state.user.charData.notes = [];
              state.user.charData.notes.push(val);
              saveState();
              input.value = '';
              renderList('notes', '#list-container');
              showToast('–ó–∞–º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
            }
          };
        }
      }

      // --- –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ ---
      function openUnlockModal() {
        const secretIds = ['korgreyv', 'porje'];

        const modal = document.createElement('div');
        modal.className = 'modal';

        const charsHTML = (state.data.characters || [])
          .filter(c => secretIds.includes(String(c.id)))
          .map(c => {
            const desc = String(c.description || '');
            const shortDesc = desc ? `${desc.substring(0, 80)}...` : '–û–ø–∏—Å–∞–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ...';

            return `
              <div class="card" style="margin-bottom:1rem; text-align:center">
                <img src="images/${c.image}" style="width:80px; height:80px; border-radius:50%; object-fit:cover; margin-bottom:0.5rem">
                <h3>${c.name}</h3>
                <p style="font-size:0.9rem">${shortDesc}</p>
                <button class="btn" onclick="APP.switchCharacter('${c.id}')">–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ–≥–æ –≥–µ—Ä–æ—è</button>
              </div>
            `;
          }).join('');

        modal.innerHTML = `
          <div class="modal-content">
            <h3 style="text-align:center; margin-bottom:1rem">–ù–æ–≤—ã–µ —Å–æ—é–∑–Ω–∏–∫–∏</h3>
            ${charsHTML || `<p style="text-align:center; opacity:0.7">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</p>`}
            <button class="btn ghost" id="close-modal">–û—Ç–º–µ–Ω–∞</button>
          </div>
        `;

        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('open'), 10);

        modal.querySelector('#close-modal').onclick = () => {
          modal.classList.remove('open');
          setTimeout(() => modal.remove(), 250);
        };
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–ø—É–±–ª–∏—á–Ω–æ —á–µ—Ä–µ–∑ APP.switchCharacter)
      function switchCharacter(newId) {
        const newChar = (state.data.characters || []).find(c => String(c.id) === String(newId));
        if (!newChar) return;

        if (confirm(`–°–º–µ–Ω–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –Ω–∞ ${newChar.name}? –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏ –∑–∞–º–µ—Ç–∫–∏ –±—É–¥—É—Ç –µ–≥–æ.`)) {
          const currentLoc = state.user.locationIndex;

          state.user.charData = JSON.parse(JSON.stringify(newChar));
          if (!state.user.charData.inventory) state.user.charData.inventory = [];
          if (!state.user.charData.notes) state.user.charData.notes = [];

          state.user.selectedCharId = newChar.id;
          state.user.locationIndex = currentLoc;

          saveState();

          const m = document.querySelector('.modal');
          if (m) m.remove();

          showToast(`–í—ã —Ç–µ–ø–µ—Ä—å: ${newChar.name}`);
          renderLocationScreen();
        }
      }

      // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è Bottom Bar ---
      function setActiveNav(name) {
        els.navItems.forEach(n => n.classList.toggle('active', n.dataset.nav === name));
      }

      els.navItems.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.nav;
          if (target === 'map') {
            if (!els.app.querySelector('.image-frame')) renderLocationScreen();
            else els.app.scrollTo({ top: 0, behavior: 'smooth' });
          } else {
            openModal(target);
          }
        });
      });

      // –ö–Ω–æ–ø–∫–∞ "–î–æ–º–æ–π"
      els.btnHome.addEventListener('click', () => {
        if (confirm('–í—ã–π—Ç–∏ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é?')) renderMainMenu();
      });

      // –í–ê–ñ–ù–û: –æ—Ç–¥–∞–µ–º switchCharacter –Ω–∞—Ä—É–∂—É, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª onclick="APP.switchCharacter(...)"
      return { init, switchCharacter };
    })();

    // –í–ê–ñ–ù–û: –¥–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ (–∏–Ω–∞—á–µ onclick –Ω–µ —É–≤–∏–¥–∏—Ç)
    window.APP = APP;

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', APP.init);
  </script>
</body>
</html>
